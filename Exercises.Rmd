---
title: "Exercises"
author: "Jacob Pammer, Chandler Wann, Narain Mandyam, Rudraksh Garg"
date: "8/7/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Problem 1: Visual story telling part 1: green buildings

To start, removing records with less than a 10% leasing rate makes sense. The histogram below, shows that these records seem to be special cases that have values far less than the average. Additionally, her theory that these low vacancy places have something wrong with them seems legitimate. Since, this will be a new building, we should assume that it will not have any of these problems.

```{r Problem 1 1, echo=FALSE}
# Reading in green data and creating a histogram of leasing rate.
df = read.csv(file = "greenbuildings.csv")
hist(df$leasing_rate, main = 'Leasing Rate Histogram',xlab = 'Leasing Rate')
df = df[df$leasing_rate > 10,]

```
Certain portions of the Guru's analysis were done correctly. For example, the use of medians is a good idea to avoid outliers. However, the analyst failed to account for potential variation in rent prices. As you can see in the side by side plots below, green rating's IQR and non-green rating's IQR cross through the same variable. So a range of estimates would be necessary to estimate a change in profits created by building a green complex.

```{r Problem 1 2, echo=FALSE}
# Dopping energy ratings and creating a two data frames of green and non green.
Monthly_Revenue = (df$Rent * df$size * (df$leasing_rate/100))
df$Monthly_Revenue_in_Mil = Monthly_Revenue/1000000
drops <- c("LEED","Energystar")
df = df[ , !(names(df) %in% drops)]
df$Rent_Diff = df$Rent - df$cluster_rent
df_green = df[df$green_rating == 1,]
df_nongreen = df[df$green_rating == 0,]
par(mfrow=c(1,2))
d0 <- seq(0, 200, by=10)
d1 <- seq(0, 200, by=10)
lmts <- range(d0,d1)
boxplot(df_green$Rent, col='green', ylim= lmts, main = 'Green Rating Rent')
boxplot(df_nongreen$Rent, ylim=lmts, main = 'Non-green Rating Rent')
```

Additionally, the analyst did not account for certain cities being more green then others. Certain clusters will have higher rents regardless of green. Therefore, failing to take this into account could be undercutting additional revenue.
Another flaw in her analysis is she failed to account for the future value of the additional expense incurred to make the building green. As shown below the future value of 5 million dollars in 8 years is in the 7 millions. This certainly should be accounted for when analyzing the potential consequences of a green building.

```{r Problem 1 3, echo=FALSE}
# Bar plots accounting for expected value
par(mfrow=c(1,2))
barplot(5 * (1+.05)^8, main = 'Future Value of 5 Million Dollars', ylab = '$ in Millions')
barplot(5, main = '5 Million Dollars', ylab = '$ in Millions',ylim = range(0,7))
```

A potential confounding variable is the age of the complex. Since green technology is rather new, it makes sense to remove the non-green rentals whose age are greater than that of the max age of the green buildings. The plot below shows that this value is at about 100 years old.

```{r Problem 1 4, echo=FALSE}
# Plotting green rating vs the age of the building
par(mfrow=c(1,1))
plot(df$green_rating, df$age, ylab = 'Age',xlab = 'green_rating',main = 'Age vs Green Rating')

```


Even though there are many flaws in this study, choosing a green building could be a viable option, but further
analysis that address our issues and confounding variables would be needed to be ensure that going green is a good decision.


# Question 2

```{r cars, echo=FALSE,message=FALSE,include=FALSE}
library(ggplot2)
library('usmap')
library(gridExtra)
library(viridis)
ABIA = read.csv('ABIA.csv')
Airports = read.csv('airports.csv')

```



```{r commondest, echo=FALSE, message=FALSE,warning=FALSE}
#Creating locational and airport codes across all airports
Latitude = Airports[5]
Longitude = Airports[6]
Codes = Airports[14]
#Putting new locational points to the Austin air data frame.
AirCodes = cbind(Latitude,Longitude,Codes)
Departure = ABIA[ABIA$Origin == 'AUS',]
Arrival = ABIA[ABIA$Origin != 'AUS',]
fullArrival = merge(Arrival,AirCodes,by.x = 'Origin',by.y = 'iata_code')
fullDeparture = merge(Departure,AirCodes,by.x = 'Dest',by.y = 'iata_code')
departureLatLong = cbind(fullDeparture$longitude_deg,fullArrival$latitude_deg)
arrivalLatLong = cbind(fullArrival$longitude_deg,fullArrival$latitude_deg)
#Using aggregate function to count observations that have a common origin point. I used year as the first parameter for a place holder because I knew there were no empty values and I was not sure how R would handle na observations.
numberofArrivals = aggregate(fullArrival$Year, by = list(Origin = fullArrival$Origin), FUN = length)
numberofDepartures = aggregate(fullDeparture$Year,by = list(Dest = fullDeparture$Dest),FUN = length)
fullArrival = merge(fullArrival,numberofArrivals,by.x = 'Origin',by.y = 'Origin')
fullDeparture = merge(fullDeparture,numberofDepartures,by.x = 'Dest',by.y = 'Dest')
#Renaming newly created variable to Count
names(fullArrival)[32]= 'Count'
#Doing a similar process as above but to calculate the percentage of flights that were cancelled.
fractionCancelled = aggregate(fullArrival$Cancelled,by = list(Origin = fullArrival$Origin),FUN = mean)
fullArrival = merge(fullArrival,fractionCancelled,by.x = 'Origin',by.y = 'Origin')
names(fullArrival)[33]= 'Fraction'
# Setting up United States map for back drop.
states = map_data('state')
#Creating a gg plot with the desired title, backdrop, color and size.
p = ggplot()+labs(title="Flights Arriving to Austin and Fraction of Cancellations")
p = p+geom_polygon(data = states, aes(x=long,y=lat,group=group),colour = 'black',fill = 'white' )
p = p + geom_jitter(data = fullArrival,aes(x = longitude_deg,y=latitude_deg,size = Count,col = Fraction)) +scale_color_viridis()
  

p
```

Above is a count of the origin locations of all the flights to Austin for the year 2021. As expected the most flights come from the Texas area. 


```{r Weather cancelled, echo=FALSE,warning=FALSE}
#Running a similar process to above. I chose max because that seemed to show the most interesting deviance in delay.

AverageDelay = aggregate(fullArrival$WeatherDelay,by = list(Origin = fullArrival$Origin),na.rm = TRUE,FUN = max)
fullArrivalw = merge(fullArrival,AverageDelay,by.x = 'Origin',by.y = 'Origin')
names(fullArrivalw)[33]= 'MaxDelay'
p3 = ggplot()+labs(title='Max Delay on Flights to Austin')
p3 = p3+geom_polygon(data = states, aes(x=long,y=lat,group=group),colour = 'black',fill = 'white' )
p3 = p3 + geom_jitter(data = fullArrivalw,aes(x = longitude_deg,y=latitude_deg,color = MaxDelay ))
p3 = p3 + scale_color_viridis()
p3

```

Above is the max delay for flights to Austin. It is interesting to note that Chicago had the largest delay.

```{r scatters, echo=FALSE, message=FALSE}
par(mfrow=c(2,2))

# Below I created plots that I thought were interesting. To do this I created several interacting plots and chose the ones that held important data.
monthvsToAustin = aggregate(fullArrival$Year,by =list(Month = fullArrival$Month),FUN = length)
plot(monthvsToAustin$Month,monthvsToAustin$x,xlab = 'Month',ylab = 'Flights to Austin',main = 'Flights to Austin vs Month of Year')


plot(fullArrival$CarrierDelay,fullArrival$TaxiIn,xlab = 'Delay in Minutes',ylab = 'Taxi Time in Minutes',main = 'Delay vs Taxi Time')

dayoWeekvsToAustin = aggregate(fullArrival$Year,by =list(Month = fullArrival$DayOfWeek),FUN = length)
plot(dayoWeekvsToAustin$Month,dayoWeekvsToAustin$x,xlab = 'Day of Week',ylab = 'Flights to Austin',main = 'Flights to Austin vs  Day of Week')

boxplot(fullDeparture$NASDelay,fullDeparture$CarrierDelay,fullDeparture$SecurityDelay,fullDeparture$LateAircraftDelay,outline = FALSE,names = c('NAS', 'Carrier','TSA', 'Plane'),xlab = 'Reason for Delay',ylab = 'Delay Time in Minutes',main = 'Reason for Delay vs Time of Delay')
#To set up the next question I reset the frame.
par(mfrow=c(1,1))
```

In the above plots we see lower flights to Austin in the months from September - December. We also see as delay increases, taxi time tends to decrease at a logarithmic rate. In the third plot we see that most days have the same amount of flights except for Saturday which is the value 6. In the last graph we see that the largest reason for delay comes from plane issues, followed by NAS which is delay due to weather adjusted for how the airport treats other weather issues.
